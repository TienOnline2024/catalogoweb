<!doctype html>
const colors = f.get('colors_template').split(',').map(c=>c.trim()).filter(Boolean);
const tags = (f.get('tags')||'').split(',').map(t=>t.trim()).filter(Boolean);
// build stock object with default stock 5 each
const stock = {};
sizes.forEach(s=>colors.forEach(c=>stock[`${s}_${c}`]=5));
const p = { id: cryptoRandom(), reference, name:f.get('name'), description:f.get('description'), price, active:true, tags, images, variants:{sizes,colors,stock}, orders:0, reviews:[] };
state.products.push(p); saveState(); renderProducts(); populateFilterOptions(); renderAdminList(); closeModal();
});
}


function renderAdminList(){
const el = document.getElementById('admin-list'); if(!el) return;
el.innerHTML='';
state.products.forEach(p=>{
const div = document.createElement('div'); div.style.borderTop='1px solid #eee'; div.style.padding='8px 0';
div.innerHTML = `<strong>${p.reference} - ${p.name}</strong> â€” ${p.active?'<em>Activo</em>':'<em>Inactivo</em>'} <div style="margin-top:6px"><button data-id="${p.id}" class="btn small-toggle">Activar/Desactivar</button> <button data-id="${p.id}" class="btn ghost small-edit">Editar</button></div>`;
el.appendChild(div);
});
el.querySelectorAll('.small-toggle').forEach(btn=>btn.addEventListener('click',e=>{ const id=btn.dataset.id; const p=state.products.find(x=>x.id===id); p.active=!p.active; saveState(); renderAdminList(); renderProducts(); }));
el.querySelectorAll('.small-edit').forEach(btn=>btn.addEventListener('click',e=>{ const id=btn.dataset.id; editProduct(id); }));
}


function editProduct(id){
const p = state.products.find(x=>x.id===id); if(!p) return; // basic edit: toggle tags and price
const html = `<h3>Editar producto ${p.reference}</h3>
<form id="edit-form">
<div class="row"><input name="name" value="${p.name}" required></div>
<div class="row"><input name="price" type="number" value="${p.price}" required></div>
<div class="row"><input name="tags" value="${(p.tags||[]).join(',')}"></div>
<div style="display:flex;gap:8px;margin-top:8px"><button class="btn" type="submit">Guardar</button><button class="btn ghost" id="cancel-edit" type="button">Cancelar</button></div>
</form>`;
openModal(html);
document.getElementById('cancel-edit').addEventListener('click',closeModal);
document.getElementById('edit-form').addEventListener('submit',ev=>{ ev.preventDefault(); const fd=new FormData(ev.target); p.name = fd.get('name'); p.price = parseInt(fd.get('price')); p.tags = (fd.get('tags')||'').split(',').map(t=>t.trim()).filter(Boolean); saveState(); closeModal(); renderProducts(); renderAdminList(); });
}


// --- Reviews rendering ---
function renderReviews(){ const el = document.getElementById('reviews'); el.innerHTML=''; state.products.slice(0,5).forEach(p=>{ (p.reviews||[]).forEach(r=>{ const d=document.createElement('div'); d.className='review'; d.innerHTML=`<strong>${r.name}</strong> â€” ${'â˜…'.repeat(r.stars)}<div class="muted">${r.txt}</div>`; el.appendChild(d); }); }); }


// --- countdown timer example ---
function startCountdown(){ const deadline = Date.now() + 1000*60*60*24; // 24h demo
const el = document.getElementById('countdown'); const iv = setInterval(()=>{
const diff = deadline - Date.now(); if(diff<=0){ el.textContent='Terminado'; clearInterval(iv); return; }
const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); const s = Math.floor((diff%60000)/1000);
el.textContent = `${h}h ${m}m ${s}s`;
},500);
}


// --- global counter UI ---
function updateGlobalCounter(){ document.getElementById('global-counter').textContent = `ðŸ“¦ MÃ¡s de ${state.globalOrders||0} pedidos realizados en total en VariedadesExpress.`; }


// --- helper: render initial ---
loadState(); seedIfEmpty(); populateFilterOptions(); renderProducts(); renderReviews(); startCountdown(); updateGlobalCounter();


// filters listeners
document.getElementById('filter-size').addEventListener('change',renderProducts);
document.getElementById('filter-color').addEventListener('change',renderProducts);
document.getElementById('filter-price').addEventListener('input',renderProducts);
document.getElementById('filter-availability').addEventListener('change',renderProducts);
document.getElementById('search').addEventListener('input',renderProducts);
document.getElementById('clear-filters').addEventListener('click',()=>{ document.getElementById('filter-size').value=''; document.getElementById('filter-color').value=''; document.getElementById('filter-price').value=''; document.getElementById('filter-availability').value=''; document.getElementById('search').value=''; renderProducts(); });


// small helpers
function renderAdminListIfOpen(){ if(document.getElementById('admin-list')) renderAdminList(); }


// expose some functions to console for debugging
window.ve = {state, saveState, renderProducts};
</script>
</body>
</html>
